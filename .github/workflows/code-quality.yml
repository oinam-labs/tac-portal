name: "Code Quality Pipeline"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  NODE_VERSION: "20"

jobs:
  # Security & Type Safety Checks
  security-checks:
    name: Security & Type Safety
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          # Check for potential hardcoded secrets
          if grep -rE "(api_key|apikey|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" .; then
            echo "⚠️ Warning: Potential hardcoded secrets found"
            exit 1
          fi
        continue-on-error: true

      - name: TypeScript strict mode check
        run: npm run typecheck

  # Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

      - name: Check console.log usage
        run: |
          # Count console.log statements (excluding tests and node_modules)
          COUNT=$(grep -r "console\.log" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=tests --exclude-dir=.archive \
            -l . 2>/dev/null | wc -l)
          echo "Found console.log in $COUNT files"
          if [ "$COUNT" -gt 300 ]; then
            echo "❌ Too many files with console.log statements (max: 300)"
            exit 1
          fi
          echo "✅ Console.log usage within limits (target: <50)"
        continue-on-error: true

      - name: Check any type usage
        run: |
          # Count explicit 'any' type usage
          COUNT=$(grep -rE ": any|as any" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=tests --exclude-dir=.archive \
            . 2>/dev/null | wc -l)
          echo "Found $COUNT instances of 'any' type"
          if [ "$COUNT" -gt 150 ]; then
            echo "❌ Too many 'any' type instances (max: 150)"
            exit 1
          fi
          echo "✅ Any type usage within acceptable limits (target: <50)"
        continue-on-error: true

      - name: Format check
        run: npm run format:check
        continue-on-error: true

  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests with coverage
        run: npm run test:unit:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # E2E Tests (requires Supabase environment)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    # Skip E2E tests if Supabase environment is not configured
    if: ${{ vars.VITE_SUPABASE_URL != '' && vars.VITE_SUPABASE_ANON_KEY != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ vars.VITE_SUPABASE_ANON_KEY }}

      - name: Start preview server and run E2E tests
        run: |
          # Start preview server in background
          npm run preview &
          SERVER_PID=$!
          
          # Wait for server to be ready (max 60 seconds)
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if curl -s http://localhost:4173 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            sleep 1
          done
          
          # Run E2E tests
          npm run test || TEST_EXIT=$?
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
          
          exit ${TEST_EXIT:-0}
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ vars.VITE_SUPABASE_ANON_KEY }}
          # Test credentials for E2E tests (non-sensitive test account)
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # Build & Bundle Analysis
  build-check:
    name: Build & Bundle Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build project
        run: npm run build

      - name: Check bundle size
        run: |
          # Check total dist size
          DIST_SIZE=$(du -sm dist 2>/dev/null | cut -f1 || echo "0")
          echo "Bundle size: ${DIST_SIZE}MB"
          if [ "$DIST_SIZE" -gt 50 ]; then
            echo "❌ Bundle size exceeds 50MB limit"
            exit 1
          fi
          echo "✅ Bundle size within limits"

  # Accessibility Checks
  accessibility:
    name: Accessibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check ARIA attributes usage
        run: |
          # Check for common accessibility attributes
          ARIA_COUNT=$(grep -r "aria-" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          ROLE_COUNT=$(grep -r "role=" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $ARIA_COUNT ARIA attributes and $ROLE_COUNT role attributes"
          echo "✅ Accessibility attributes present"

      - name: Check for alt text on images
        run: |
          # Check images have alt text
          IMG_WITHOUT_ALT=$(grep -rE "<img[^>]+(?!alt=)" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | grep -v "alt=" | wc -l)
          if [ "$IMG_WITHOUT_ALT" -gt 0 ]; then
            echo "⚠️ Warning: Some images may be missing alt text"
          fi
          echo "✅ Alt text check complete"

  # Performance Anti-patterns
  performance:
    name: Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for performance anti-patterns
        run: |
          # Check for inline function definitions in JSX (potential re-render issues)
          INLINE_FNS=$(grep -rE "onClick=\{\\(\\)" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $INLINE_FNS potential inline function definitions"
          
          # Check for missing React.memo on large components
          echo "✅ Performance anti-pattern check complete"

      - name: Check for lazy loading usage
        run: |
          LAZY_IMPORTS=$(grep -r "lazy(" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $LAZY_IMPORTS lazy-loaded components"
          echo "✅ Lazy loading check complete"
