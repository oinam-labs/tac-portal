# TAC Cargo — Architecture Report
> Generated: 2026-01-22 | Windsurf AI Agent Setup

---

## 1) Stack Summary

| Layer | Technology |
|-------|-----------|
| Framework | Vite + React 19 + TypeScript (SPA) |
| Router | react-router-dom (client-side) |
| Auth/DB | Supabase (@supabase/supabase-js) |
| Server State | TanStack React Query |
| Client State | Zustand (persisted stores) |
| UI | Tailwind v4 + Radix UI + shadcn/ui + motion/gsap |
| Observability | Sentry (@sentry/react) |
| Testing | Vitest (unit) + Playwright (e2e) |
| PDF/Labels | pdf-lib + jsbarcode |
| Scanning | ZXing (barcode parsing) |

---

## 2) Project Structure

```
tac-portal/
├── App.tsx                    # Main router + layout
├── index.tsx                  # Entry point
├── globals.css                # Tailwind base styles
├── components/                # UI components (109 items)
│   ├── ui/                    # shadcn/ui primitives (42 items)
│   ├── domain/                # Domain-specific components (14 items)
│   ├── manifests/             # Manifest module components (8 items)
│   ├── dashboard/             # Dashboard widgets (7 items)
│   ├── finance/               # Invoice/finance components (4 items)
│   └── ...
├── pages/                     # Route pages (18 items)
│   ├── Dashboard.tsx
│   ├── Customers.tsx
│   ├── Shipments.tsx
│   ├── Manifests.tsx
│   ├── Scanning.tsx
│   ├── Exceptions.tsx
│   ├── Finance.tsx (Invoices)
│   ├── Analytics.tsx
│   ├── Tracking.tsx
│   ├── Inventory.tsx
│   └── ...
├── lib/                       # Core utilities (48 items)
│   ├── supabase.ts            # Supabase client
│   ├── database.types.ts      # Generated DB types
│   ├── services/              # Data services (11 items)
│   ├── schemas/               # Zod validation schemas (4 items)
│   ├── errors.ts              # Error handling system
│   ├── pdf-generator.ts       # Label/invoice PDF generation
│   ├── scanParser.ts          # Barcode parsing logic
│   ├── queryKeys.ts           # React Query key factory
│   └── sentry.ts              # Sentry config
├── hooks/                     # React hooks (15 items)
│   ├── useCustomers.ts
│   ├── useShipments.ts
│   ├── useManifests.ts
│   ├── useInvoices.ts
│   ├── useExceptions.ts
│   ├── useRBAC.ts             # Role-based access
│   └── ...
├── store/                     # Zustand stores (6 items)
│   ├── authStore.ts           # Auth state
│   ├── scanQueueStore.ts      # Offline-first scan queue
│   ├── auditStore.ts          # Audit trail state
│   └── ...
├── supabase/                  # DB migrations + functions
│   ├── migrations/
│   │   ├── 002_rls_policies.sql
│   │   ├── 003_hub_access_and_constraints.sql
│   │   ├── 004_invoice_numbering.sql
│   │   └── 005_invoice_rls_and_audit.sql
│   └── functions/             # Edge functions
├── tests/
│   ├── unit/                  # Vitest tests
│   └── e2e/                   # Playwright tests
└── docs/                      # Documentation (21 items)
```

---

## 3) Module → Domain Mapping

### Core Domains

| Module | Page | Service | Hook | Key Entities |
|--------|------|---------|------|--------------|
| **Invoices** | Finance.tsx | invoiceService.ts | useInvoices.ts | invoices, invoice_counters |
| **Customers** | Customers.tsx | customerService.ts | useCustomers.ts | customers |
| **Shipments** | Shipments.tsx | shipmentService.ts | useShipments.ts | shipments, tracking_events |
| **Manifests** | Manifests.tsx | manifestService.ts | useManifests.ts | manifests, manifest_items |
| **Scanning** | Scanning.tsx | scanQueueStore.ts | - | tracking_events |

### Secondary Domains

| Module | Page | Notes |
|--------|------|-------|
| **Dashboard** | Dashboard.tsx | Stats aggregation from all domains |
| **Analytics** | Analytics.tsx | Read-only reports/charts |
| **Operations** | (integrated) | Workflow orchestration |
| **Tracking** | Tracking.tsx, PublicTracking.tsx | tracking_events timeline |
| **Inventory** | Inventory.tsx | Package location management |
| **Exceptions** | Exceptions.tsx | Exception queue + resolution |
| **Business** | Finance.tsx | Invoice/billing workflows |
| **Management** | Management.tsx | Staff/hub/org admin |

---

## 4) Critical Patterns Discovered

### 4.1 Data Access Pattern
- **Services** (`lib/services/*.ts`): Direct Supabase calls with org_id scoping
- **Hooks** (`hooks/use*.ts`): TanStack Query wrappers with query keys
- **Stores** (`store/*.ts`): Zustand for local/offline state

### 4.2 Invoice Numbering (CRITICAL)
- **Format**: `INV-YYYY-NNNN` (e.g., `INV-2026-0001`)
- **Generated by**: Database trigger `set_invoice_no` (migration 004)
- **Counter table**: `invoice_counters(org_id, year, last_number)`
- **Risk**: Never generate invoice numbers client-side

### 4.3 AWB/Barcode Format (CRITICAL)
- **Format**: `TAC` + 8 digits (e.g., `TAC12345678`)
- **Validation**: `lib/scanParser.ts` → `isValidAWB()`
- **Generation**: `generate_awb_number` RPC or client fallback

### 4.4 Manifest Number Format
- **Format**: `MNF-YYYY-NNNNNN` (e.g., `MNF-2024-123456`)
- **Generated in**: `manifestService.create()` (client-side timestamp)

### 4.5 Scanning Idempotency (CRITICAL)
- **Offline queue**: `store/scanQueueStore.ts` with localStorage persistence
- **Unique scan ID**: `scan_${Date.now()}_${random9chars}`
- **Tracking events**: Insert-only, immutable records
- **Sync retry**: 30-second interval when online

### 4.6 Status Transitions
**Shipment statuses** (from services):
- `CREATED` → `RECEIVED` → `LOADED_FOR_LINEHAUL` → `IN_TRANSIT` → `RECEIVED_AT_DEST` → `DELIVERED`
- Exception branch: Any → `EXCEPTION` → (resolved) → previous state

**Manifest statuses**:
- `OPEN` → `CLOSED` → `DEPARTED` → `ARRIVED`

**Invoice statuses**:
- `ISSUED` → `PAID` or `CANCELLED`

### 4.7 Error Handling
- **Central system**: `lib/errors.ts`
- **Error classes**: `ValidationError`, `AuthenticationError`, `AuthorizationError`, `NotFoundError`, `ConflictError`, `NetworkError`
- **Supabase mapping**: `mapSupabaseError()` for PG error codes
- **Toast notifications**: `showErrorToast()`, `showSuccessToast()`

### 4.8 Validation
- **Zod schemas**: `lib/schemas/*.ts` (auth, customers, shipment)
- **Runtime validation**: Applied in hooks/services before mutations

### 4.9 Soft Deletes
- All core entities use `deleted_at` column (soft delete pattern)
- Queries filter `.is('deleted_at', null)`

### 4.10 Audit Logging
- **Table**: `audit_logs(entity_type, entity_id, action, before, after, actor_staff_id)`
- **RLS**: Enforced per org_id

---

## 5) Security Findings

### 5.1 Row Level Security (RLS)
- Enabled on all core tables (migrations 002, 005)
- Scoped by `org_id` for multi-tenancy
- Service role bypasses RLS for admin operations

### 5.2 Auth Flow
- Supabase Auth with email/password
- Session management in `authStore.ts`
- RBAC via `useRBAC.ts` hook

### 5.3 Sensitive Operations
- Invoice counter table locked to `service_role` only
- PDF generation client-side (no server secrets)

---

## 6) Risk Areas

| Risk | Severity | Location | Mitigation |
|------|----------|----------|------------|
| Invoice number collision | HIGH | invoiceService.create | DB trigger handles atomicity |
| Duplicate scan events | HIGH | scanQueueStore | Unique scan_id + idempotency |
| Manifest modified after close | MEDIUM | manifestService.addShipment | Status check before mutation |
| PDF layout regression | MEDIUM | pdf-generator.ts | Sample verification |
| Offline data loss | MEDIUM | scanQueueStore | localStorage persistence |
| RLS bypass | HIGH | service_role calls | Audit all service_role usage |

---

## 7) Conventions Extracted

### Naming
- **Services**: `{entity}Service.ts` with exported object
- **Hooks**: `use{Entity}.ts` with `{entity}Keys` query factory
- **Pages**: PascalCase `{Module}.tsx`
- **Components**: PascalCase, domain-grouped folders

### Code Style
- TypeScript strict mode
- Async/await for all Supabase calls
- Error mapping via `mapSupabaseError()`
- Toast notifications for user feedback

### Testing
- Unit: `tests/unit/**/*.test.ts` (Vitest)
- E2E: `tests/e2e/**/*.spec.ts` (Playwright)
- Setup: `tests/unit/setup.ts`

---

## 8) Verification Commands

```bash
npm run typecheck    # TypeScript compilation check
npm run lint         # ESLint
npm run test:unit    # Vitest unit tests
npm run test         # Playwright e2e tests
npm run format:check # Prettier check
```

---

*Report generated by Windsurf AI Agent for enterprise AI-automation setup.*
