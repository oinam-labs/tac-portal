---
description: Audit database integrity - constraints, RLS, idempotency, audit trails
---

# /audit-db-integrity — Database Integrity Audit

## Goal
Verify all database operations maintain data integrity, enforce constraints, and preserve audit trails.

## Preconditions
- Access to Supabase dashboard or generated types
- Understanding of `lib/database.types.ts`

## Steps

### Step 1: Schema Review
Review current schema from `lib/database.types.ts`:
- List all tables
- Identify primary keys, foreign keys
- Note nullable vs required fields

### Step 2: RLS Policy Check
For each core table, verify:
- [ ] RLS enabled
- [ ] SELECT scoped by org_id
- [ ] INSERT validates org_id
- [ ] UPDATE prevents cross-org
- [ ] DELETE (if allowed) scoped

Tables to check:
- `shipments`
- `customers`
- `invoices`
- `manifests`
- `manifest_items`
- `exceptions`
- `tracking_events`
- `audit_logs`

### Step 3: Service Org Scoping
Grep for org scoping in services:
```bash
# Check all services use org_id
grep -r "org_id" lib/services/
```

Verify pattern:
```typescript
const orgId = orgService.getCurrentOrgId();
.eq('org_id', orgId)
```

### Step 4: Soft Delete Verification
Check all delete operations use soft delete:
```bash
grep -r "\.delete()" lib/services/
```

Should NOT find hard deletes on core tables. Should find:
```typescript
.update({ deleted_at: new Date().toISOString() })
```

### Step 5: Idempotency Check
Verify idempotency patterns:
- [ ] `scanQueueStore.ts`: Unique scan IDs
- [ ] `manifestService.addShipment`: Duplicate check before insert
- [ ] `invoiceService.create`: DB trigger for unique numbers

### Step 6: Identifier Format Check
- [ ] Invoice: Generated by `set_invoice_no` trigger
- [ ] AWB: Validated by `isValidAWB()` regex
- [ ] Manifest: Generated in `manifestService.create()`

### Step 7: Audit Trail Verification
Check `auditService.ts` and audit_logs usage:
- [ ] Entity creation logged
- [ ] Status changes logged
- [ ] Deletions logged

### Step 8: Run Type Check
```bash
// turbo
npm run typecheck
```

## Output Format

```markdown
## DB Integrity Audit Report — [Date]

### Schema Summary
| Table | PK | FK Count | RLS |
|-------|----|---------|----|
| shipments | uuid | 4 | ✅ |
| customers | uuid | 1 | ✅ |
| ... | ... | ... | ... |

### RLS Status
- [x] All core tables have RLS enabled
- [x] Policies scope by org_id

### Org Scoping
- [x] All services use `orgService.getCurrentOrgId()`
- [ ] Issue: [file] missing org_id filter

### Soft Deletes
- [x] No hard deletes found
- [ ] Issue: [location]

### Idempotency
- [x] Scan queue uses unique IDs
- [x] Manifest items check duplicates
- [x] Invoice numbers DB-generated

### Identifier Formats
| Type | Format | Verified |
|------|--------|----------|
| Invoice | INV-YYYY-NNNN | ✅ |
| AWB | TAC######## | ✅ |
| Manifest | MNF-YYYY-NNNNNN | ✅ |

### Audit Trail
- [x] audit_logs table exists
- [ ] Missing: [entity] changes not logged

### Issues Found
1. **[Severity]**: [Description] — [Location]

### Recommendations
1. [Recommendation]

## Risk/Rollback
- Risk: May find integrity issues requiring migration
- Rollback: N/A (audit is read-only)
