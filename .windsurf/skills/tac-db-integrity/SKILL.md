---
name: tac-db-integrity
description: Validate and harden Supabase DB operations: constraints, idempotency, consistency, and audit trails.
version: 2.0.0
tags: [database, integrity, supabase, sql, constraints]
---

# DB Integrity Skill (Supabase)

## Purpose
Ensure all database operations maintain data integrity, enforce constraints, and preserve audit trails. Use this skill when modifying any data access code or database schema.

## Preconditions
- [ ] Access to Supabase dashboard or CLI
- [ ] Understanding of current schema (`lib/database.types.ts`)
- [ ] Knowledge of RLS policies in place

## Step-by-Step Procedure

### Step 1: Identify Affected Tables
List all tables that will be read from or written to:
```
Tables: shipments, tracking_events, manifests, ...
Operations: SELECT, INSERT, UPDATE
```

### Step 2: Verify Org Scoping
Every query MUST include org_id filter:
```typescript
// Check pattern
.eq('org_id', orgService.getCurrentOrgId())
```

### Step 3: Check Constraint Compliance

| Constraint Type | What to Verify |
|-----------------|----------------|
| Primary Key | Unique ID generation (UUID) |
| Foreign Keys | Referenced records exist |
| Not Null | Required fields provided |
| Unique | No duplicate violations |
| Check | Value within allowed range |

### Step 4: Validate Idempotency
For write operations, ensure:
- [ ] Duplicate submissions don't create duplicates
- [ ] Unique keys/constraints prevent collisions
- [ ] Upsert patterns used where appropriate

### Step 5: Review RLS Impact
Test the operation as:
- [ ] Authenticated user (their org only)
- [ ] Different org user (should fail/return empty)
- [ ] Unauthenticated (should fail)

### Step 6: Audit Trail
Verify audit logging for:
- [ ] Entity creation
- [ ] Status changes
- [ ] Deletions (soft)
- [ ] Critical field updates

### Step 7: Transaction Boundaries
For multi-step operations:
- [ ] All steps succeed or all fail
- [ ] No partial state possible
- [ ] Consider Edge Function for atomicity

## Invariants Checklist

### Invoice Numbering
- [ ] Format: `INV-YYYY-NNNN`
- [ ] Generated by DB trigger only
- [ ] Sequential per org+year
- [ ] Never modified after creation

### AWB Numbers
- [ ] Format: `TAC` + 8 digits
- [ ] Unique per org
- [ ] Generated via RPC or client fallback
- [ ] Never modified after creation

### Manifest Numbers
- [ ] Format: `MNF-YYYY-NNNNNN`
- [ ] Unique per org
- [ ] Timestamp-based generation acceptable

### Soft Deletes
- [ ] All deletes set `deleted_at`
- [ ] All queries filter `.is('deleted_at', null)`
- [ ] No hard DELETEs on core tables

## Common Failure Cases

| Failure | Symptom | Prevention |
|---------|---------|------------|
| Missing org_id | Data leak across orgs | Always filter by org_id |
| FK violation | Insert fails | Verify parent exists first |
| Duplicate key | 23505 error | Check existence or use upsert |
| RLS denial | 42501 error | Verify user has permission |
| Null violation | 23502 error | Validate required fields |

## Migration Checklist

If schema change required:
- [ ] Create migration file: `supabase/migrations/NNN_description.sql`
- [ ] Enable RLS: `ALTER TABLE ... ENABLE ROW LEVEL SECURITY`
- [ ] Add RLS policies for SELECT, INSERT, UPDATE, DELETE
- [ ] Regenerate types: Update `database.types.ts`
- [ ] Test rollback path
- [ ] Document in `docs/architecture/database.md`

## Required Tests

```bash
# Type check after schema change
npm run typecheck

# Unit test for service
npm run test:unit -- --grep "serviceName"
```

## Output Format

```markdown
## DB Integrity Analysis

### Tables Affected
- `table_name`: [operations]

### Invariants Verified
- [x] Org scoping
- [x] Soft deletes
- [ ] Audit logging (needs addition)

### Failure Cases Handled
- FK violation: [how handled]
- Duplicate: [how handled]

### Migration Required
[Yes/No - if yes, provide SQL]

### Recommendations
1. [Recommendation]
