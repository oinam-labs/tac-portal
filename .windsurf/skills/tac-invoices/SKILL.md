---
name: tac-invoices
description: Invoice module operations including creation, PDF generation, and payment workflows.
version: 2.0.0
tags: [tac, invoices, pdf, billing, critical]
---

# Invoice Operations Skill

## Purpose
Handle invoice CRUD operations, PDF generation, and payment workflows while maintaining financial data integrity and audit compliance.

## Preconditions
- [ ] Understanding of invoice numbering system (DB-generated)
- [ ] Access to `invoiceService.ts` and `useInvoices.ts`
- [ ] Test customer and shipment data available

## Critical Constraints

### Invoice Number Format
```
INV-YYYY-NNNN
Example: INV-2026-0001
```
**NEVER** generate invoice numbers client-side. The DB trigger handles this.

### Invoice Statuses
| Status | Description | Transitions |
|--------|-------------|-------------|
| `ISSUED` | Created, awaiting payment | → PAID, CANCELLED |
| `PAID` | Payment received | Terminal |
| `CANCELLED` | Voided | Terminal |

## Step-by-Step Procedures

### Creating an Invoice
1. Validate customer exists
2. Validate shipment exists (if linked)
3. Prepare line items with amounts
4. Call `invoiceService.create()` - DB generates invoice_no
5. Verify response includes generated invoice_no
6. Create audit log entry

```typescript
// Service call - note org_id and invoice_no omitted
const invoice = await invoiceService.create({
  customer_id: customerId,
  shipment_id: shipmentId,
  line_items: items,
  subtotal: calculateSubtotal(items),
  tax_amount: calculateTax(subtotal, taxRate),
  total: subtotal + tax - discount,
});
```

### Generating Invoice PDF
1. Fetch invoice with relations (customer, shipment)
2. Call `generateInvoicePDF(invoice)` from `lib/pdf-generator.ts`
3. Verify all fields render correctly
4. Verify barcode scans properly

### Marking Invoice Paid
```typescript
await invoiceService.markPaid(invoiceId);
// Creates audit log, updates status to PAID
```

### Cancelling Invoice
```typescript
await invoiceService.cancel(invoiceId);
// Creates audit log, updates status to CANCELLED
```

## Calculation Rules

All calculations must be **deterministic**:

```typescript
const calculateInvoiceTotal = (items: LineItem[], taxRate: number, discount: number) => {
  const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
  const tax = Math.round(subtotal * taxRate * 100) / 100; // Round to 2 decimals
  const total = subtotal + tax - discount;
  return { subtotal, tax, total };
};
```

## PDF Output Contract

### Invoice PDF (A4)
- Dimensions: 595 × 842 points
- Margins: 40pt all sides
- Header: Company info + logo position
- Invoice number: Prominent, top-right
- Customer details: Below header
- Line items: Table format
- Totals: Right-aligned
- Footer: Terms and conditions

### Verification Checklist
- [ ] Invoice number renders correctly
- [ ] Customer name/address correct
- [ ] Line items match data
- [ ] Subtotal matches sum
- [ ] Tax calculated correctly
- [ ] Total = subtotal + tax - discount
- [ ] Currency format: Rs. X,XXX.XX
- [ ] Date format: DD MMM YYYY

## Common Failure Modes

| Issue | Cause | Prevention |
|-------|-------|------------|
| Duplicate invoice_no | Client-side generation | Use DB trigger only |
| Wrong total | Floating point | Round to 2 decimals |
| Missing customer | Deleted customer | Check exists before |
| PDF blank | Missing data | Validate all fields |

## Required Tests

```bash
# Invoice calculation tests
npm run test:unit -- --grep "invoice"

# PDF generation test
npm run test:unit -- --grep "pdf"
```

## Files Reference

| File | Purpose |
|------|---------|
| `lib/services/invoiceService.ts` | CRUD operations |
| `hooks/useInvoices.ts` | React Query hooks |
| `lib/pdf-generator.ts` | PDF generation |
| `pages/Finance.tsx` | Invoice UI |
| `supabase/migrations/004_invoice_numbering.sql` | Number generation |

## Output Format

```markdown
## Invoice Operation Result

### Action: [Create/Update/Cancel]
- Invoice ID: `uuid`
- Invoice No: `INV-2026-XXXX`
- Status: [ISSUED/PAID/CANCELLED]

### Verification
- [ ] Invoice number generated by DB
- [ ] Calculations verified
- [ ] PDF renders correctly
- [ ] Audit log created
