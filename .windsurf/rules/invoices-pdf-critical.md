---
description: Critical rules for invoice numbering and PDF/label generation
activation: always
---

# Invoices & PDF Critical Rule

## Why This Rule Exists
Invoices are **legal financial documents**. Labels are **physical artifacts** printed on thermal paper. Any change to their format or calculation logic can cause:
- Tax compliance failures
- Customer disputes
- Operational chaos (labels don't scan)
- Revenue loss (incorrect totals)

This rule protects invoice integrity and PDF output contracts.

---

## Invoice Numbering (CRITICAL)

### Format
```
INV-YYYY-NNNN
```
Example: `INV-2026-0001`, `INV-2026-0002`, ...

### Generation Rules
1. **Server-side only**: Invoice numbers are generated by PostgreSQL trigger
2. **Never generate client-side**: The `invoice_no` field is auto-populated
3. **Sequential per org+year**: Counter table ensures no gaps/duplicates

### Implementation (migration 004)
```sql
-- Counter table (service_role access only)
CREATE TABLE public.invoice_counters (
  org_id uuid NOT NULL,
  year integer NOT NULL,
  last_number integer NOT NULL DEFAULT 0,
  PRIMARY KEY (org_id, year)
);

-- Trigger on insert
CREATE TRIGGER set_invoice_no
  BEFORE INSERT ON public.invoices
  FOR EACH ROW
  EXECUTE FUNCTION public.set_invoice_no();
```

### Service Pattern
```typescript
// invoiceService.create - DO NOT set invoice_no
async create(invoice: Omit<InvoiceInsert, 'org_id' | 'invoice_no'>) {
  const { data, error } = await supabase
    .from('invoices')
    .insert({
      ...invoice,
      org_id: orgId,
      // invoice_no is NOT set - DB generates it
    })
    .select()
    .single();
}
```

---

## Invoice Calculations (Deterministic)

### Required Fields
| Field | Type | Calculation |
|-------|------|-------------|
| subtotal | number | Sum of line items |
| tax_amount | number | subtotal × tax_rate |
| discount | number | Applied discount |
| total | number | subtotal + tax_amount - discount |

### Calculation Must Be Reproducible
Given the same inputs, the same total must always result:

```typescript
// Correct - pure function
const calculateInvoiceTotal = (items, taxRate, discount) => {
  const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
  const tax = Math.round(subtotal * taxRate * 100) / 100;
  const total = subtotal + tax - discount;
  return { subtotal, tax, total };
};

// Wrong - non-deterministic
const total = items.reduce(...) + Math.random(); // NEVER
```

---

## PDF Output Contract

### Label Dimensions (4x6 inch)
- Width: 288 points (4 inches × 72 dpi)
- Height: 432 points (6 inches × 72 dpi)
- Thermal printer compatible

### Invoice PDF (A4)
- Width: 595 points
- Height: 842 points
- Margins: 40pt all sides

### Required Elements (Labels)
1. **Header**: Company logo position (top-left)
2. **AWB Barcode**: CODE128 format, scannable
3. **Routing**: Origin → Destination hub codes
4. **Consignee**: Name, phone, address
5. **Weight/Pieces**: Package count, total weight
6. **Service type**: EXPRESS/STANDARD indicator

### Barcode Generation
```typescript
// lib/pdf-generator.ts
function generate1DBarcode(text: string): string {
  const sanitized = text.replace(/[^A-Za-z0-9-]/g, '').substring(0, 20);
  JsBarcode(canvas, sanitized, {
    format: "CODE128",
    width: 4,
    height: 80,
    displayValue: false,
  });
  return canvas.toDataURL('image/png');
}
```

---

## Change Control for PDFs

### Before Any PDF/Label Change
1. **Capture baseline**: Generate 3+ sample PDFs with current code
2. **Make change**: Implement modification
3. **Compare outputs**: Visual diff against baseline
4. **Verify scanning**: Test barcode with physical scanner or ZXing
5. **Document**: Note what changed and why

### Regression Checklist
- [ ] AWB barcode scans correctly
- [ ] Invoice number renders at correct position
- [ ] Currency formatting preserves ₹ or Rs. symbol
- [ ] Dates format as DD MMM YYYY
- [ ] Total matches sum of line items
- [ ] QR code (if present) decodes correctly
- [ ] Printable on thermal paper (labels)
- [ ] Printable on A4 (invoices)

---

## Invoice Statuses

| Status | Description | Transitions |
|--------|-------------|-------------|
| `ISSUED` | Created, pending payment | → PAID, CANCELLED |
| `PAID` | Payment received | (terminal) |
| `CANCELLED` | Voided | (terminal) |

### Status Change Rules
```typescript
// invoiceService.ts
async markPaid(id: string): Promise<Invoice> {
  return this.update(id, { status: 'PAID' });
}

async cancel(id: string): Promise<Invoice> {
  return this.update(id, { status: 'CANCELLED' });
}
```

---

## Currency Handling

### Display Format
```typescript
// lib/utils.ts
export const formatCurrency = (amount: number) => 
  new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
  }).format(amount);

// PDF-safe (no unicode)
const safeCurrency = (amount: number) => 
  formatCurrency(amount).replace(/₹/g, 'Rs. ');
```

### Storage
- Store amounts as integers (paise) or decimals with 2 precision
- Never store formatted strings

---

## Testing Requirements

### Unit Tests
- Invoice total calculation
- Barcode generation for edge cases (short/long AWB)
- Currency formatting

### Visual Regression (Recommended)
- Snapshot test for PDF output
- Compare pixel-by-pixel or use PDF diff tool

### Manual QA Checklist
- [ ] Print label on thermal printer
- [ ] Scan barcode with warehouse scanner
- [ ] Print invoice on A4
- [ ] Verify totals match line items
- [ ] Check date formatting
